

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>autoprofutils.SharedFunctions &mdash; AutoProf 0.8 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> AutoProf
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citation.html">Citing AutoProf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">LICENSE</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../defaultpipeline.html">Default AutoProf Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipelinemanipulation.html">AutoProf Pipeline Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../decisiontrees.html">Decision Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extramethods.html">Extra Methods</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AutoProf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>autoprofutils.SharedFunctions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for autoprofutils.SharedFunctions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">trapz</span><span class="p">,</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">iqr</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp2d</span><span class="p">,</span> <span class="n">SmoothBivariateSpline</span><span class="p">,</span> <span class="n">Rbf</span><span class="p">,</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve2d</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">LogStretch</span><span class="p">,</span> <span class="n">HistEqStretch</span>
<span class="kn">from</span> <span class="nn">astropy.visualization.mpl_normalize</span> <span class="kn">import</span> <span class="n">ImageNormalize</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">photutils.isophote</span> <span class="kn">import</span> <span class="n">EllipseSample</span><span class="p">,</span> <span class="n">EllipseGeometry</span><span class="p">,</span> <span class="n">Isophote</span><span class="p">,</span> <span class="n">IsophoteList</span>
<span class="kn">from</span> <span class="nn">photutils.isophote</span> <span class="kn">import</span> <span class="n">Ellipse</span> <span class="k">as</span> <span class="n">Photutils_Ellipse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="kn">import</span> <span class="n">get_sample_data</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>

<span class="n">Abs_Mag_Sun</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mf">6.39</span><span class="p">,</span>
               <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="mf">5.11</span><span class="p">,</span>
               <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mf">4.65</span><span class="p">,</span>
               <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mf">4.53</span><span class="p">,</span>
               <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mf">4.50</span><span class="p">,</span>
               <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="mf">6.33</span><span class="p">,</span>
               <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">5.31</span><span class="p">,</span>
               <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mf">4.80</span><span class="p">,</span>
               <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="mf">4.60</span><span class="p">,</span>
               <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mf">4.51</span><span class="p">,</span>
               <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="mf">4.54</span><span class="p">,</span>
               <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mf">4.66</span><span class="p">,</span>
               <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mf">5.08</span><span class="p">,</span>
               <span class="s1">&#39;3.6um&#39;</span><span class="p">:</span> <span class="mf">3.24</span><span class="p">}</span>     <span class="c1"># mips.as.arizona.edu/~cnaw/sun.html # also see: http://www.astronomy.ohio-state.edu/~martini/usefuldata.html</span>
<span class="n">Au_to_Pc</span>    <span class="o">=</span> <span class="mf">4.84814e-6</span>         <span class="c1"># pc au^-1</span>
<span class="n">Pc_to_m</span>     <span class="o">=</span> <span class="mf">3.086e16</span>           <span class="c1"># m pc^-1</span>
<span class="n">Pc_to_Au</span>    <span class="o">=</span> <span class="mf">206265.</span>            <span class="c1"># Au pc^-1</span>

<span class="n">cmaplist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#000000&#39;</span><span class="p">,</span> <span class="s1">&#39;#720026&#39;</span><span class="p">,</span> <span class="s1">&#39;#A0213F&#39;</span><span class="p">,</span> <span class="s1">&#39;#ce4257&#39;</span><span class="p">,</span> <span class="s1">&#39;#E76154&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9b54&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffd1b1&#39;</span><span class="p">]</span>
<span class="n">cdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">cpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">)):</span>
    <span class="n">cdict</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cpoints</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">])</span>
    <span class="n">cdict</span><span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cpoints</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">])</span>
    <span class="n">cdict</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cpoints</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">cmaplist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">/</span><span class="mi">256</span><span class="p">])</span>
<span class="n">autocmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="p">(</span><span class="s1">&#39;autocmap&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
<span class="n">autocolours</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;red1&#39;</span><span class="p">:</span> <span class="s1">&#39;#c33248&#39;</span><span class="p">,</span> <span class="s1">&#39;blue1&#39;</span><span class="p">:</span> <span class="s1">&#39;#84DCCF&#39;</span><span class="p">,</span> <span class="s1">&#39;blue2&#39;</span><span class="p">:</span> <span class="s1">&#39;#6F8AB7&#39;</span><span class="p">,</span> <span class="s1">&#39;redrange&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#720026&#39;</span><span class="p">,</span> <span class="s1">&#39;#A0213F&#39;</span><span class="p">,</span> <span class="s1">&#39;#ce4257&#39;</span><span class="p">,</span> <span class="s1">&#39;#E76154&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9b54&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffd1b1&#39;</span><span class="p">]}</span> <span class="c1"># &#39;#D95D39&#39;</span>
    
<div class="viewcode-block" id="LSBImage"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.LSBImage">[docs]</a><span class="k">def</span> <span class="nf">LSBImage</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">noise</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Greys&#39;</span><span class="p">,</span>
               <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">HistEqStretch</span><span class="p">(</span><span class="n">dat</span><span class="p">)))</span> 
    <span class="n">my_cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span>
    <span class="n">my_cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="n">a_min</span> <span class="o">=</span> <span class="n">noise</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">),</span>
               <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">my_cmap</span><span class="p">,</span>
               <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">(),</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
               <span class="n">clim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">noise</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">vmin</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">noise</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span></div>
    
<div class="viewcode-block" id="AddLogo"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.AddLogo">[docs]</a><span class="k">def</span> <span class="nf">AddLogo</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.844</span><span class="o">/</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.185</span><span class="o">/</span><span class="mi">5</span><span class="p">],</span> <span class="n">white</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">get_sample_data</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AUTOPROF&#39;</span><span class="p">],</span> <span class="s1">&#39;_static/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;AP_logo_white.png&#39;</span> <span class="k">if</span> <span class="n">white</span> <span class="k">else</span> <span class="s1">&#39;AP_logo.png&#39;</span><span class="p">))))</span>
    <span class="n">newax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">white</span><span class="p">:</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">newax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">newax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="flux_to_sb"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.flux_to_sb">[docs]</a><span class="k">def</span> <span class="nf">flux_to_sb</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">zeropoint</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">+</span> <span class="n">zeropoint</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pixscale</span><span class="p">)</span></div>

<div class="viewcode-block" id="flux_to_mag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.flux_to_mag">[docs]</a><span class="k">def</span> <span class="nf">flux_to_mag</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">zeropoint</span><span class="p">,</span> <span class="n">fluxe</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fluxe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">+</span> <span class="n">zeropoint</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">+</span> <span class="n">zeropoint</span><span class="p">,</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">fluxe</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">flux</span><span class="p">)</span></div>

<div class="viewcode-block" id="sb_to_flux"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.sb_to_flux">[docs]</a><span class="k">def</span> <span class="nf">sb_to_flux</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">pixscale</span><span class="p">,</span> <span class="n">zeropoint</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">pixscale</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">sb</span> <span class="o">-</span> <span class="n">zeropoint</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span></div>

<div class="viewcode-block" id="mag_to_flux"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.mag_to_flux">[docs]</a><span class="k">def</span> <span class="nf">mag_to_flux</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="n">zeropoint</span><span class="p">,</span> <span class="n">mage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">mag</span> <span class="o">-</span> <span class="n">zeropoint</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">I</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">mag</span> <span class="o">-</span> <span class="n">zeropoint</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">I</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">I</span><span class="o">*</span><span class="n">mage</span><span class="o">/</span><span class="mf">2.5</span></div>

<div class="viewcode-block" id="magperarcsec2_to_mag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.magperarcsec2_to_mag">[docs]</a><span class="k">def</span> <span class="nf">magperarcsec2_to_mag</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts mag/arcsec^2 to mag</span>
<span class="sd">    mu: mag/arcsec^2</span>
<span class="sd">    a: semi major axis radius (arcsec)</span>
<span class="sd">    b: semi minor axis radius (arcsec)</span>
<span class="sd">    A: pre-calculated area (arcsec^2)</span>
<span class="sd">    returns: mag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1"># https://en.wikipedia.org/wiki/Surface_brightness#Calculating_surface_brightness</span></div>

<div class="viewcode-block" id="mag_to_magperarcsec2"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.mag_to_magperarcsec2">[docs]</a><span class="k">def</span> <span class="nf">mag_to_magperarcsec2</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts mag to mag/arcsec^2</span>
<span class="sd">    m: mag</span>
<span class="sd">    a: semi major axis radius (arcsec)</span>
<span class="sd">    b: semi minor axis radius (arcsec)</span>
<span class="sd">    A: pre-calculated area (arcsec^2)</span>
<span class="sd">    returns: mag/arcsec^2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="ow">not</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">R</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">+</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1"># https://en.wikipedia.org/wiki/Surface_brightness#Calculating_surface_brightness</span></div>

<div class="viewcode-block" id="halfmag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.halfmag">[docs]</a><span class="k">def</span> <span class="nf">halfmag</span><span class="p">(</span><span class="n">mag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the magnitude corresponding to half in log space.</span>
<span class="sd">    Effectively, converts to luminosity, divides by 2, then</span>
<span class="sd">    converts back to magnitude. Distance is not needed as it</span>
<span class="sd">    cancels out. Here is a basic walk through::</span>
<span class="sd">    </span>
<span class="sd">      m_1 - m_ref = -2.5log10(I_1/I_ref)</span>
<span class="sd">      m_2 - m_ref = -2.5log10(I_1/2I_ref)</span>
<span class="sd">                  = -2.5log10(I_1/I_ref) + 2.5log10(2)</span>
<span class="sd">      m_2 = m_1 + 2.5log10(2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">mag</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="pc_to_arcsec"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.pc_to_arcsec">[docs]</a><span class="k">def</span> <span class="nf">pc_to_arcsec</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Re</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">De</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a size in parsec to arcseconds</span>

<span class="sd">    R: length in pc</span>
<span class="sd">    D: distance in pc</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">Au_to_Pc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Re</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">De</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">theta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Re</span><span class="o">/</span><span class="n">R</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">De</span><span class="o">/</span><span class="n">D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">e</span></div>

<div class="viewcode-block" id="arcsec_to_pc"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.arcsec_to_pc">[docs]</a><span class="k">def</span> <span class="nf">arcsec_to_pc</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">thetae</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">De</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a size in arcseconds to parsec</span>

<span class="sd">    theta: angle in arcsec</span>
<span class="sd">    D: distance in pc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Au_to_Pc</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">thetae</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">De</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">thetae</span> <span class="o">/</span> <span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">De</span> <span class="o">/</span> <span class="n">D</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">e</span></div>

<div class="viewcode-block" id="ISB_to_muSB"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.ISB_to_muSB">[docs]</a><span class="k">def</span> <span class="nf">ISB_to_muSB</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">IE</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts surface brightness in Lsolar pc^-2 into mag arcsec^-2</span>

<span class="sd">    I: surface brightness, (L/Lsun) pc^-2</span>
<span class="sd">    band: Photometric band in which measurements were taken</span>
<span class="sd">    returns: surface brightness in mag arcsec^-2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">muSB</span> <span class="o">=</span> <span class="mf">21.571</span> <span class="o">+</span> <span class="n">Abs_Mag_Sun</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">muSB</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">muSB</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="n">IE</span> <span class="o">/</span> <span class="n">I</span></div>

<div class="viewcode-block" id="muSB_to_ISB"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.muSB_to_ISB">[docs]</a><span class="k">def</span> <span class="nf">muSB_to_ISB</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">muE</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts surface brightness in mag arcsec^-2 into Lsolar pc^-2</span>

<span class="sd">    mu: surface brightness, mag arcsec^-2</span>
<span class="sd">    band: Photometric band in which measurements were taken</span>
<span class="sd">    returns: surface brightness in (L/Lsun) pc^-2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ISB</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="mf">21.571</span> <span class="o">+</span> <span class="n">Abs_Mag_Sun</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">muE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ISB</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ISB</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ISB</span> <span class="o">*</span> <span class="n">muE</span></div>

<div class="viewcode-block" id="app_mag_to_abs_mag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.app_mag_to_abs_mag">[docs]</a><span class="k">def</span> <span class="nf">app_mag_to_abs_mag</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">me</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">De</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an apparent magnitude to an absolute magnitude</span>
<span class="sd">    m: Apparent magnitude</span>
<span class="sd">    D: Distance to object in parsecs</span>
<span class="sd">    returns: Absolute magnitude at 10 parcecs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">me</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">De</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">M</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">M</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">me</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">De</span> <span class="o">/</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="abs_mag_to_app_mag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.abs_mag_to_app_mag">[docs]</a><span class="k">def</span> <span class="nf">abs_mag_to_app_mag</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Me</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">De</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an absolute magnitude to an apparent magnitude</span>
<span class="sd">    M: Absolute magnitude at 10 parcecs</span>
<span class="sd">    D: Distance to object in parsecs</span>
<span class="sd">    returns: Apparent magnitude</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Me</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">De</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Me</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">5.</span> <span class="o">*</span> <span class="n">De</span> <span class="o">/</span> <span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="mag_to_L"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.mag_to_L">[docs]</a><span class="k">def</span> <span class="nf">mag_to_L</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">mage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zeropoint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the luminosity (in solar luminosities) given the absolute magnitude and reference point.</span>
<span class="sd">    mag: Absolute magnitude</span>
<span class="sd">    band: Photometric band in which measurements were taken</span>
<span class="sd">    mage: uncertainty in absolute magnitude</span>
<span class="sd">    zeropoint: user defined zero point</span>
<span class="sd">    returns: Luminosity in solar luminosities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(((</span><span class="n">Abs_Mag_Sun</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="k">if</span> <span class="n">zeropoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">zeropoint</span><span class="p">)</span> <span class="o">-</span> <span class="n">mag</span><span class="p">)</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">L</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Le</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="n">mage</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">L</span><span class="p">,</span> <span class="n">Le</span></div>

<div class="viewcode-block" id="L_to_mag"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.L_to_mag">[docs]</a><span class="k">def</span> <span class="nf">L_to_mag</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">Le</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zeropoint</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the Absolute magnitude of a star given its luminosity and distance</span>
<span class="sd">    L: Luminosity in solar luminosities</span>
<span class="sd">    band: Photometric band in which measurements were taken</span>
<span class="sd">    Le: Uncertainty in luminosity</span>
<span class="sd">    zeropoint: user defined zero point</span>
<span class="sd">    </span>
<span class="sd">    returns: Absolute magnitude</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">Abs_Mag_Sun</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="k">if</span> <span class="n">zeropoint</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">zeropoint</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">Le</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mag</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">Le</span> <span class="o">/</span> <span class="p">(</span><span class="n">L</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">mag</span><span class="p">,</span> <span class="n">mage</span></div>

<div class="viewcode-block" id="Sigma_Clip_Upper"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Sigma_Clip_Upper">[docs]</a><span class="k">def</span> <span class="nf">Sigma_Clip_Upper</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nsigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform sigma clipping on the &quot;v&quot; array. Each iteration involves</span>
<span class="sd">    computing the median and 16-84 range, these are used to clip beyond</span>
<span class="sd">    &quot;nsigma&quot; number of sigma above the median. This is repeated for</span>
<span class="sd">    &quot;iterations&quot; number of iterations, or until convergence if None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">old_lim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iterations</span> <span class="ow">and</span> <span class="n">old_lim</span> <span class="o">!=</span> <span class="n">lim</span><span class="p">:</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">v2</span> <span class="o">&lt;</span> <span class="n">lim</span><span class="p">])</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">v2</span> <span class="o">&lt;</span> <span class="n">lim</span><span class="p">],</span><span class="n">rng</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">84</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">old_lim</span> <span class="o">=</span> <span class="n">lim</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="n">med</span> <span class="o">+</span> <span class="n">rng</span><span class="o">*</span><span class="n">nsigma</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">lim</span></div>

<div class="viewcode-block" id="Smooth_Mode"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Smooth_Mode">[docs]</a><span class="k">def</span> <span class="nf">Smooth_Mode</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="c1"># set the starting point for the optimization at the median</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="c1"># set the smoothing scale equal to roughly 0.5% of the width of the data</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#/10</span>
    <span class="c1"># Fit the peak of the smoothed histogram</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">],</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<span class="k">def</span> <span class="nf">_average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Smooth_Mode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized average method: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_scatter</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iqr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="p">(</span><span class="mf">31.731</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mf">31.731</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iqr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="p">(</span><span class="mf">31.731</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mf">31.731</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized average method: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

<div class="viewcode-block" id="interpolate_bicubic"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.interpolate_bicubic">[docs]</a><span class="k">def</span> <span class="nf">interpolate_bicubic</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="n">f_interp</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                   <span class="n">dat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_interp</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">grid</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="interpolate_Lanczos"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.interpolate_Lanczos">[docs]</a><span class="k">def</span> <span class="nf">interpolate_Lanczos</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Lanczos interpolation on an image.</span>
<span class="sd">    https://pixinsight.com/doc/docs/InterpolationAlgorithms/InterpolationAlgorithms.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="n">box</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span> <span class="nb">min</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))],</span>
               <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span> <span class="nb">min</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))]]</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">Lx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">XX</span>
        <span class="n">Ly</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">YY</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">Lx</span> <span class="o">*</span> <span class="n">Ly</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span> <span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
              <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span> <span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chunk</span><span class="o">*</span><span class="n">L</span><span class="p">)</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_iso_between</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">sma_low</span><span class="p">,</span> <span class="n">sma_high</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">sigmaclip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sclip_iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sclip_nsigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">PARAMS</span><span class="p">:</span>
        <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Rlim</span> <span class="o">=</span> <span class="n">sma_high</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="k">if</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))))</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Rlim</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">Rlim</span><span class="o">+</span><span class="mi">2</span><span class="p">))],</span>
              <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Rlim</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">Rlim</span><span class="o">+</span><span class="mi">2</span><span class="p">))]]</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">))</span>
    <span class="n">XX</span> <span class="o">-=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">YY</span> <span class="o">-=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">YY</span><span class="o">/</span><span class="n">XX</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">XX</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">YY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]),</span> <span class="n">XX</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">YY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]))</span>
    <span class="n">YY</span> <span class="o">/=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;ellip&#39;</span><span class="p">]</span>
    <span class="n">Fmodescaling</span> <span class="o">=</span> <span class="mf">1.</span> <span class="k">if</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;Phim&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]))))</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">XX</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">YY</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Fmodescaling</span>
    <span class="n">rselect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">RR</span> <span class="o">&lt;</span> <span class="n">sma_high</span><span class="p">,</span> <span class="n">RR</span> <span class="o">&gt;</span> <span class="n">sma_low</span><span class="p">)</span>
    <span class="n">fluxes</span> <span class="o">=</span> <span class="n">IMG</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">rselect</span><span class="p">]</span>
    <span class="n">CHOOSE</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sma_high</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">rselect</span><span class="p">])</span>
    <span class="c1"># Perform sigma clipping if requested</span>
    <span class="k">if</span> <span class="n">sigmaclip</span><span class="p">:</span>
        <span class="n">sclim</span> <span class="o">=</span> <span class="n">Sigma_Clip_Upper</span><span class="p">(</span><span class="n">fluxes</span><span class="p">,</span> <span class="n">sclip_iterations</span><span class="p">,</span> <span class="n">sclip_nsigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">fluxes</span> <span class="o">&lt;</span> <span class="n">sclim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">,</span> <span class="n">fluxes</span> <span class="o">&lt;</span> <span class="n">sclim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Entire Isophote is Masked! R_l: </span><span class="si">%.3f</span><span class="s1">, R_h: </span><span class="si">%.3f</span><span class="s1">, PA: </span><span class="si">%.3f</span><span class="s1">, ellip: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sma_low</span><span class="p">,</span> <span class="n">sma_high</span><span class="p">,</span> <span class="n">pa</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">eps</span><span class="p">))</span>
        <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">CHOOSE</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">more</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sma_high</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fluxes</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">rselect</span><span class="p">][</span><span class="n">CHOOSE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="n">rselect</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sma_high</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fluxes</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fluxes</span>

<span class="k">def</span> <span class="nf">_iso_extract</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">sma</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minN</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interp_mask</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">rad_interp</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">interp_method</span> <span class="o">=</span> <span class="s1">&#39;lanczos&#39;</span><span class="p">,</span> <span class="n">interp_window</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sigmaclip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">sclip_iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sclip_nsigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal, basic function for extracting the pixel fluxes along an isophote</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;m&#39;</span> <span class="ow">in</span> <span class="n">PARAMS</span><span class="p">:</span>
        <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sma</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">minN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minN</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="c1"># points along ellipse to evaluate</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">/</span><span class="n">N</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">sma</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">if</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;Phim&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))))</span>
    <span class="c1"># Define ellipse</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;ellip&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="c1"># rotate ellipse by PA</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">Y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">X</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">Y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">+</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">])</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># Reject samples from outside the image</span>
    <span class="n">BORDER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">X</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">X</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">Y</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">BORDER</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">BORDER</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">BORDER</span><span class="p">]</span>

    <span class="n">Rlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Rlim</span> <span class="o">&lt;</span> <span class="n">rad_interp</span><span class="p">:</span> 
        <span class="n">box</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Rlim</span><span class="o">-</span><span class="mi">5</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">Rlim</span><span class="o">+</span><span class="mi">5</span><span class="p">))],</span>
               <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">Rlim</span><span class="o">-</span><span class="mi">5</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">Rlim</span><span class="o">+</span><span class="mi">5</span><span class="p">))]]</span>
        <span class="k">if</span> <span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;bicubic&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">interpolate_bicubic</span><span class="p">(</span><span class="n">IMG</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">X</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">interp_method</span> <span class="o">==</span> <span class="s1">&#39;lanczos&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">interpolate_Lanczos</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">interp_window</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown interpolate method </span><span class="si">%s</span><span class="s1">. Should be one of lanczos or bicubic&#39;</span> <span class="o">%</span> <span class="n">interp_method</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># round to integers and sample pixels values</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">IMG</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)]</span>
    <span class="c1"># CHOOSE holds bolean array for which flux values to keep, initialized as None for no clipping</span>
    <span class="n">CHOOSE</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Mask pixels if a mask is given</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)])</span>
    <span class="c1"># Perform sigma clipping if requested</span>
    <span class="k">if</span> <span class="n">sigmaclip</span><span class="p">:</span>
        <span class="n">sclim</span> <span class="o">=</span> <span class="n">Sigma_Clip_Upper</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">sclip_iterations</span><span class="p">,</span> <span class="n">sclip_nsigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">&lt;</span> <span class="n">sclim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">,</span> <span class="n">flux</span> <span class="o">&lt;</span> <span class="n">sclim</span><span class="p">)</span>
    <span class="c1"># Dont clip pixels if that removes all of the pixels</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Entire Isophote is Masked! R: </span><span class="si">%.3f</span><span class="s1">, PA: </span><span class="si">%.3f</span><span class="s1">, ellip: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;pa&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">PARAMS</span><span class="p">[</span><span class="s1">&#39;ellip&#39;</span><span class="p">]))</span>
        <span class="c1"># Interpolate clipped flux values if requested</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">interp_mask</span><span class="p">:</span>
        <span class="n">flux</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">)],</span> <span class="n">theta</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">],</span> <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="c1"># simply remove all clipped pixels if user doesn&#39;t reqest another option</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">CHOOSE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">CHOOSE</span><span class="p">]</span>
        <span class="n">countmasked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">CHOOSE</span><span class="p">))</span>
        
    <span class="c1"># Return just the flux values, or flux and angle values</span>
    <span class="k">if</span> <span class="n">more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">theta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span>

<span class="k">def</span> <span class="nf">_iso_line</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pa</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">more</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]])</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">length</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa</span><span class="p">)])</span>
    
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">))],</span>
              <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">2</span><span class="p">))]]</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">))</span>
    <span class="n">XX</span> <span class="o">-=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">YY</span> <span class="o">-=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">pa</span><span class="p">)</span> <span class="o">-</span> <span class="n">YY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">pa</span><span class="p">),</span> <span class="n">XX</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">pa</span><span class="p">)</span> <span class="o">+</span> <span class="n">YY</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">pa</span><span class="p">))</span>

    <span class="n">lselect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">XX</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">XX</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">IMG</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">lselect</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">more</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">XX</span><span class="p">[</span><span class="n">lselect</span><span class="p">],</span> <span class="n">YY</span><span class="p">[</span><span class="n">lselect</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">XX</span><span class="p">[</span><span class="n">lselect</span><span class="p">]</span>            
        
<div class="viewcode-block" id="StarFind"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.StarFind">[docs]</a><span class="k">def</span> <span class="nf">StarFind</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">fwhm_guess</span><span class="p">,</span> <span class="n">background_noise</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">peakmax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detect_threshold</span> <span class="o">=</span> <span class="mf">20.</span><span class="p">,</span> <span class="n">minsep</span> <span class="o">=</span> <span class="mf">10.</span><span class="p">,</span> <span class="n">reject_size</span> <span class="o">=</span> <span class="mf">10.</span><span class="p">,</span> <span class="n">maxstars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find stars in an image, determine their fwhm and peak flux values.</span>

<span class="sd">    IMG: image data as numpy 2D array</span>
<span class="sd">    fwhm_guess: A guess at the PSF fwhm, can be within a factor of 2 and everything should work</span>
<span class="sd">    background_noise: image background flux noise</span>
<span class="sd">    mask: masked pixels as numpy 2D array with same dimensions as IMG</span>
<span class="sd">    peakmax: maximum allowed peak flux value for a star, used to remove saturated pixels</span>
<span class="sd">    detect_threshold: threshold (in units of sigma) value for convolved image to consider a pixel as a star candidate.</span>
<span class="sd">    minsep: minimum allowed separation between stars, in units of fwhm_guess</span>
<span class="sd">    reject_size: reject stars with fitted FWHM greater than this times the fwhm_guess</span>
<span class="sd">    maxstars: stop once this number of stars have been found, this is for speed purposes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convolve edge detector with image</span>
    <span class="n">S</span> <span class="o">=</span> <span class="mi">3</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
    <span class="n">S</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="mi">3</span> <span class="o">-</span> <span class="n">fwhm_guess</span><span class="p">))])</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">S</span><span class="p">,</span><span class="n">S</span><span class="p">))</span><span class="o">*-</span><span class="mi">1</span>
    <span class="n">zz</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">S</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="o">/</span><span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="n">new</span> <span class="o">=</span> <span class="n">convolve2d</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">deformities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fwhms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Select pixels which edge detector identifies</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">highpixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">detect_threshold</span><span class="o">*</span><span class="n">iqr</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">highpixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="n">detect_threshold</span><span class="o">*</span><span class="n">iqr</span><span class="p">(</span><span class="n">new</span><span class="p">),</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">highpixels</span><span class="p">)</span>
    <span class="c1"># meshgrid for 2D polynomial fit (pre-built for efficiency)</span>
    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="o">*</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">yy</span><span class="o">*</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">highpixels</span><span class="p">)):</span>
        <span class="c1"># reject if near an existing center</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">highpixels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">centers</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># reject if near edge</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">highpixels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">highpixels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="c1"># set starting point at local maximum pixel</span>
        <span class="n">newcenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">highpixels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">highpixels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fwhm_guess</span><span class="o">*</span><span class="mi">5</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fwhm_guess</span><span class="o">*</span><span class="mi">5</span><span class="p">))],</span>
                  <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">fwhm_guess</span><span class="o">*</span><span class="mi">5</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">fwhm_guess</span><span class="o">*</span><span class="mi">5</span><span class="p">))]]</span>
        <span class="n">newcenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">IMG</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                     <span class="n">IMG</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">newcenter</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="c1"># update star center with 2D polynomial fit</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">))],</span>
                  <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">))]]</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">IMG</span><span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">a_min</span> <span class="o">=</span> <span class="n">background_noise</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">poly2dfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="n">rcond</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">newcenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">poly2dfit</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">poly2dfit</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]),</span> <span class="o">-</span><span class="n">poly2dfit</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">poly2dfit</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])])</span>
        <span class="c1"># reject if 2D polynomial maximum is outside the fitting region</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">newcenter</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># reject centers that are outside the image</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">newcenter</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">IMG</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="c1"># reject stars with too high flux</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">peakmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">IMG</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">),</span>
                                                <span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">)]</span> <span class="o">&gt;=</span> <span class="n">peakmax</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># reject if near existing center</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">newcenter</span> <span class="o">-</span> <span class="n">centers</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">minsep</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Extract flux as a function of radius</span>
        <span class="n">local_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">_iso_extract</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">reject_size</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ellip&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]}))</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">_iso_extract</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;ellip&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]}))</span> <span class="o">-</span> <span class="n">local_flux</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">local_flux</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">detect_threshold</span><span class="o">*</span><span class="n">background_noise</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">deformity</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
        <span class="n">badcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">background_noise</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span> <span class="c1">#len(R) &lt; 50 and (flux[-1] &gt; background_noise or len(R) &lt;= 5):</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">fwhm_guess</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">isovals</span> <span class="o">=</span> <span class="n">_iso_extract</span><span class="p">(</span><span class="n">IMG</span><span class="p">,</span> <span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;ellip&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">newcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span> <span class="c1"># cause finder to skip this star</span>
                <span class="k">break</span>
            <span class="n">coefs</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">isovals</span><span class="p">)</span>
            <span class="n">deformity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coefs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isovals</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">isovals</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">background_noise</span><span class="p">)))</span> <span class="c1"># np.sqrt(np.abs(coefs[0]))</span>
            <span class="c1"># if np.sum(np.abs(coefs[1:5])) &gt; np.sqrt(np.abs(coefs[0])):</span>
            <span class="c1">#     badcount += 1</span>
            <span class="n">flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">isovals</span><span class="p">)</span> <span class="o">-</span> <span class="n">local_flux</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">fwhm_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">flux</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span><span class="o">*</span><span class="mi">2</span>
        
        <span class="c1"># reject if fitted FWHM unrealistically large</span>
        <span class="k">if</span> <span class="n">fwhm_fit</span> <span class="o">&gt;</span> <span class="n">reject_size</span><span class="o">*</span><span class="n">fwhm_guess</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Add star to list</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">newcenter</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">centers</span><span class="p">,[</span><span class="n">newcenter</span><span class="p">]),</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">deformities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deformity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fwhms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">fwhm_fit</span><span class="p">))</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># stop if max N stars reached</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fwhms</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxstars</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># ranges = [[max(0,int(newcenter[0]-fwhm_guess*5)), min(IMG.shape[1],int(newcenter[0]+fwhm_guess*5))],</span>
        <span class="c1">#           [max(0,int(newcenter[1]-fwhm_guess*5)), min(IMG.shape[0],int(newcenter[1]+fwhm_guess*5))]]</span>
        <span class="c1"># plt.imshow(np.clip(IMG[ranges[1][0]: ranges[1][1], ranges[0][0]: ranges[0][1]],</span>
        <span class="c1">#                    a_min = 0,a_max = None), origin = &#39;lower&#39;, cmap = &#39;Greys_r&#39;, norm = ImageNormalize(stretch=LogStretch()))</span>
        <span class="c1"># plt.scatter([newcenter[0] - ranges[0][0]], [newcenter[1] - ranges[1][0]], color = &#39;r&#39;, marker = &#39;x&#39;)</span>
        <span class="c1"># plt.scatter([com_center[0] - ranges[0][0]], [com_center[1] - ranges[1][0]], color = &#39;b&#39;, marker = &#39;x&#39;)</span>
        <span class="c1"># #plt.scatter([highpixels[i][1] - ranges[0][0]], [highpixels[i][0] - ranges[1][0]], color = &#39;g&#39;, marker = &#39;x&#39;)</span>
        <span class="c1"># plt.savefig(&#39;test/PSF_test_%i_center.jpg&#39; % randid)</span>
        <span class="c1"># plt.close()</span>
        
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">centers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">centers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhms</span><span class="p">),</span> <span class="s1">&#39;peak&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="s1">&#39;deformity&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deformities</span><span class="p">)}</span></div>



<span class="k">def</span> <span class="nf">_x_to_pa</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal, basic function to ensure position angles remain</span>
<span class="sd">    in the proper parameter space (0, pi)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="c1">#np.pi / (1. + np.exp(-(x-np.pi/2)))</span>
<span class="k">def</span> <span class="nf">_inv_x_to_pa</span><span class="p">(</span><span class="n">pa</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal, reverse _x_to_pa, although this is just a filler</span>
<span class="sd">    function as _x_to_pa is non reversible.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pa</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<div class="viewcode-block" id="PA_shift_convention"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.PA_shift_convention">[docs]</a><span class="k">def</span> <span class="nf">PA_shift_convention</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alternates between standard mathematical convention for angles, and astronomical position angle convention.</span>
<span class="sd">    The standard convention is to measure angles counter-clockwise relative to the positive x-axis</span>
<span class="sd">    The astronomical convention is to measure angles counter-clockwise relative to the positive y-axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">deg</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mf">180.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">pa</span> <span class="o">-</span> <span class="p">(</span><span class="n">shift</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">%</span> <span class="n">shift</span></div>

<span class="k">def</span> <span class="nf">_x_to_eps</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal, function to map the reals to the range (0.0,1.0)</span>
<span class="sd">    as the range of reasonable ellipticity values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#0.02 + 0.96/(1. + np.exp(-(x - 0.5))) </span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_inv_x_to_eps</span><span class="p">(</span><span class="n">eps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal, inverse of _x_to_eps function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">eps</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span> <span class="c1">#0.5 - np.log(0.96/(eps - 0.02) - 1.) </span>


<div class="viewcode-block" id="Read_Image"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Read_Image">[docs]</a><span class="k">def</span> <span class="nf">Read_Image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a galaxy image given a file name. In a fits image the data is assumed to exist in the</span>
<span class="sd">    primary HDU unless given &#39;hdulelement&#39;. In a numpy file, it is assumed that only one image</span>
<span class="sd">    is in the file.</span>
<span class="sd">    </span>
<span class="sd">    filename: A string containing the full path to an image file</span>

<span class="sd">    returns: Extracted image data as numpy 2D array</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read a fits file</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fits&#39;</span><span class="p">:</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ap_hdulelement&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ap_hdulelement&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">else</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="c1"># Read a numpy array file</span>
    <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="n">filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;npy&#39;</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span></div>

<div class="viewcode-block" id="Angle_TwoAngles"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Angle_TwoAngles">[docs]</a><span class="k">def</span> <span class="nf">Angle_TwoAngles</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the angle between two vectors at angles a1 and a2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span> <span class="c1">#np.arccos(np.sin(a1)*np.sin(a2) + np.cos(a1)*np.cos(a2))</span></div>
    
<div class="viewcode-block" id="Angle_Average"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Angle_Average">[docs]</a><span class="k">def</span> <span class="nf">Angle_Average</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the average for a list of angles, which may wrap around a cyclic boundary.</span>

<span class="sd">    a: list of angles in the range [0,2pi]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i</span><span class="p">))</span></div>

<div class="viewcode-block" id="Angle_Median"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Angle_Median">[docs]</a><span class="k">def</span> <span class="nf">Angle_Median</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the median for a list of angles, which may wrap around a cyclic boundary.</span>

<span class="sd">    a: list of angles in the range [0,2pi]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Angle_Scatter"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Angle_Scatter">[docs]</a><span class="k">def</span> <span class="nf">Angle_Scatter</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the scatter for a list of angles, which may wrap around a cyclic boundary.</span>

<span class="sd">    a: list of angles in the range [0,2pi]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iqr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="n">rng</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span><span class="mi">84</span><span class="p">])</span></div>


<div class="viewcode-block" id="GetOptions"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.GetOptions">[docs]</a><span class="k">def</span> <span class="nf">GetOptions</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract all of the AutoProf user optionional parameters form the config file.</span>
<span class="sd">    User options are identified as any python object that starts with &quot;ap\_&quot; in the</span>
<span class="sd">    variable name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newoptions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ap_&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newoptions</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        
    <span class="k">return</span> <span class="n">newoptions</span></div>

   
<div class="viewcode-block" id="fluxdens_to_fluxsum"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.fluxdens_to_fluxsum">[docs]</a><span class="k">def</span> <span class="nf">fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">axisratio</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate a flux density profile</span>

<span class="sd">    R: semi-major axis length (arcsec)</span>
<span class="sd">    I: flux density (flux/arcsec^2)</span>
<span class="sd">    axisratio: b/a profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">axisratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">I</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">R</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">axisratio</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">R</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">S</span></div>

<div class="viewcode-block" id="fluxdens_to_fluxsum_errorprop"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.fluxdens_to_fluxsum_errorprop">[docs]</a><span class="k">def</span> <span class="nf">fluxdens_to_fluxsum_errorprop</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="n">axisratio</span><span class="p">,</span> <span class="n">axisratioE</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">symmetric_error</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate a flux density profile</span>

<span class="sd">    R: semi-major axis length (arcsec)</span>
<span class="sd">    I: flux density (flux/arcsec^2)</span>
<span class="sd">    axisratio: b/a profile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axisratioE</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axisratioE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    
    <span class="c1"># Create container for the monte-carlo iterations</span>
    <span class="n">sum_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span> <span class="o">-</span> <span class="mf">99.999</span>
    <span class="n">I_CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="n">I</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">I_CHOOSE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">symmetric_error</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">I_CHOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">axisratio</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># Randomly sampled SB profile</span>
        <span class="n">tempI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="n">I</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">IE</span><span class="p">))</span>
        <span class="c1"># Randomly sampled axis ratio profile</span>
        <span class="n">tempq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="n">axisratio</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">axisratioE</span><span class="p">)),</span> <span class="n">a_min</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="c1"># Compute COG with sampled data</span>
        <span class="n">sum_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">I_CHOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">tempI</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">tempq</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">])</span>

    <span class="c1"># Condense monte-carlo evaluations into profile and uncertainty envelope</span>
    <span class="n">sum_lower</span> <span class="o">=</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sum_results</span><span class="p">,</span> <span class="mf">0.317310507863</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sum_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sum_results</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">0.317310507863</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Return requested uncertainty format</span>
    <span class="k">if</span> <span class="n">symmetric_error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sum_lower</span> <span class="o">+</span> <span class="n">sum_upper</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sum_lower</span><span class="p">,</span> <span class="n">sum_upper</span></div>

<span class="k">def</span> <span class="nf">_Fmode_integrand</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="n">fsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Phim&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span>
    <span class="n">dfsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Am&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;Phim&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">])))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fsum</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">fsum</span><span class="p">)</span><span class="o">*</span><span class="n">dfsum</span>

<div class="viewcode-block" id="Fmode_Areas"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Fmode_Areas">[docs]</a><span class="k">def</span> <span class="nf">Fmode_Areas</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>

    <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
        <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ellip&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">quad</span><span class="p">(</span><span class="n">_Fmode_integrand</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">],))[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fmode_fluxdens_to_fluxsum"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Fmode_fluxdens_to_fluxsum">[docs]</a><span class="k">def</span> <span class="nf">Fmode_fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate a flux density profile, with isophotes including Fourier perturbations.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    R: arcsec</span>
<span class="sd">      semi-major axis length</span>
<span class="sd">    </span>
<span class="sd">    I: flux/arcsec^2</span>
<span class="sd">      flux density</span>
<span class="sd">    </span>
<span class="sd">    parameters: list of dictionaries</span>
<span class="sd">      list of dictionary of isophote shape parameters for each radius.</span>
<span class="sd">      formatted as</span>
<span class="sd">    </span>
<span class="sd">      .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">        {&#39;ellip&#39;: ellipticity,</span>
<span class="sd">         &#39;m&#39;: list of modes used,</span>
<span class="sd">         &#39;Am&#39;: list of mode powers,</span>
<span class="sd">         &#39;Phim&#39;: list of mode phases</span>

<span class="sd">      }</span>

<span class="sd">      entries for each radius.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">))):</span>
        <span class="k">return</span> <span class="n">fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)))))</span>
    
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">Fmode_Areas</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Adiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
        <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="n">I</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Adiff</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">R</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">S</span></div>

<div class="viewcode-block" id="Fmode_fluxdens_to_fluxsum_errorprop"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.Fmode_fluxdens_to_fluxsum_errorprop">[docs]</a><span class="k">def</span> <span class="nf">Fmode_fluxdens_to_fluxsum_errorprop</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">symmetric_error</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate a flux density profile, with isophotes including Fourier perturbations.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    R: arcsec</span>
<span class="sd">      semi-major axis length</span>
<span class="sd">    </span>
<span class="sd">    I: flux/arcsec^2</span>
<span class="sd">      flux density</span>
<span class="sd">    </span>
<span class="sd">    parameters: list of dictionaries</span>
<span class="sd">      list of dictionary of isophote shape parameters for each radius.</span>
<span class="sd">      formatted as</span>
<span class="sd">    </span>
<span class="sd">      .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">        {&#39;ellip&#39;: ellipticity,</span>
<span class="sd">         &#39;m&#39;: list of modes used,</span>
<span class="sd">         &#39;Am&#39;: list of mode powers,</span>
<span class="sd">         &#39;Phim&#39;: list of mode phases</span>

<span class="sd">      }</span>

<span class="sd">      entries for each radius.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ellip err&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ellip err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">))):</span>
        <span class="k">return</span> <span class="n">fluxdens_to_fluxsum_errorprop</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">IE</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)))),</span>
                                             <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip err&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)))),</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">symmetric_error</span> <span class="o">=</span> <span class="n">symmetric_error</span><span class="p">)</span>
        
    <span class="c1"># Create container for the monte-carlo iterations</span>
    <span class="n">sum_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)))</span> <span class="o">-</span> <span class="mf">99.999</span>
    <span class="n">I_CHOOSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="n">I</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">I_CHOOSE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">symmetric_error</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">cut_parameters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">I_CHOOSE</span><span class="p">))</span>
    <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">I_CHOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fmode_fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">cut_parameters</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># Randomly sampled SB profile</span>
        <span class="n">tempI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="n">I</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">IE</span><span class="p">))</span>
        <span class="c1"># Randomly sampled axis ratio profile</span>
        <span class="n">temp_parameters</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">cut_parameters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cut_parameters</span><span class="p">)):</span>
            <span class="n">temp_parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="n">cut_parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip&#39;</span><span class="p">],</span>
                                                                   <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cut_parameters</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;ellip err&#39;</span><span class="p">])),</span>
                                                  <span class="n">a_min</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">a_max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="c1"># Compute COG with sampled data</span>
        <span class="n">sum_results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">I_CHOOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fmode_fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">tempI</span><span class="p">[</span><span class="n">I_CHOOSE</span><span class="p">],</span> <span class="n">temp_parameters</span><span class="p">)</span>

    <span class="c1"># Condense monte-carlo evaluations into profile and uncertainty envelope</span>
    <span class="n">sum_lower</span> <span class="o">=</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sum_results</span><span class="p">,</span> <span class="mf">0.317310507863</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sum_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">sum_results</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">-</span> <span class="mf">0.317310507863</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Return requested uncertainty format</span>
    <span class="k">if</span> <span class="n">symmetric_error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sum_lower</span> <span class="o">+</span> <span class="n">sum_upper</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sum_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sum_lower</span><span class="p">,</span> <span class="n">sum_upper</span></div>
    

    
<div class="viewcode-block" id="SBprof_to_COG"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.SBprof_to_COG">[docs]</a><span class="k">def</span> <span class="nf">SBprof_to_COG</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a surface brightness profile to a curve of growth by integrating</span>
<span class="sd">    the SB profile in flux units then converting back to mag units. Two methods</span>
<span class="sd">    are implemented, one using the trapezoid method and one assuming constant</span>
<span class="sd">    SB between isophotes. Trapezoid method is in principle more accurate, but</span>
<span class="sd">    may become unstable with erratic data.</span>

<span class="sd">    R: Radius in arcsec</span>
<span class="sd">    SB: surface brightness in mag arcsec^-2</span>
<span class="sd">    axisratio: b/a indicating degree of isophote ellipticity</span>
<span class="sd">    method: 0 for trapezoid, 1 for constant</span>

<span class="sd">    returns: magnitude values at each radius of the profile in mag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># m = np.zeros(len(R))</span>
    <span class="c1"># # Dummy band for conversions, cancelled out on return</span>
    <span class="c1"># band = &#39;r&#39;</span>
    
    <span class="c1"># # Method 0 uses trapezoid method to integrate in flux space</span>
    <span class="c1"># if method == 0:</span>
    <span class="c1">#     # Compute the starting point assuming constant SB within first isophote</span>
    <span class="c1">#     m[0] = magperarcsec2_to_mag(SB[0], A = np.pi*axisratio[0]*(R[0]**2))</span>
    <span class="c1">#     # Dummy distance value for integral</span>
    <span class="c1">#     D = 10</span>
    <span class="c1">#     # Convert to flux space</span>
    <span class="c1">#     I = muSB_to_ISB(np.array(SB), band)</span>
    <span class="c1">#     # Ensure numpy array</span>
    <span class="c1">#     axisratio = np.array(axisratio)</span>
    <span class="c1">#     # Convert to physical radius using dummy distance</span>
    <span class="c1">#     R = arcsec_to_pc(np.array(R), D)</span>
    <span class="c1">#     # Integrate up to each radius in the profile</span>
    <span class="c1">#     for i in range(1,len(R)):</span>
    <span class="c1">#         m[i] = abs_mag_to_app_mag(L_to_mag(trapz(2*np.pi*I[:i+1]*R[:i+1]*axisratio[:i+1],R[:i+1]) + \</span>
    <span class="c1">#                                            mag_to_L(app_mag_to_abs_mag(m[0], D), band), band),D)</span>
    <span class="c1"># elif method == 1:</span>
    <span class="c1">#     # Compute the starting point assuming constant SB within first isophote</span>
    <span class="c1">#     m[0] = magperarcsec2_to_mag(SB[0], A = np.pi*axisratio[0]*(R[0]**2))</span>
    <span class="c1">#     # Progress through each radius and add the contribution from each isophote individually</span>
    <span class="c1">#     for i in range(1,len(R)):</span>
    <span class="c1">#         m[i] = L_to_mag(mag_to_L(magperarcsec2_to_mag(SB[i], A = np.pi*axisratio[i]*(R[i]**2)), band) - \</span>
    <span class="c1">#                         mag_to_L(magperarcsec2_to_mag(SB[i], A = np.pi*axisratio[i-1]*(R[i-1]**2)), band) + \</span>
    <span class="c1">#                         mag_to_L(m[i-1], band), band)</span>

    <span class="k">return</span> <span class="n">flux_to_mag</span><span class="p">(</span><span class="n">Fmode_fluxdens_to_fluxsum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">mag_to_flux</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">parameters</span><span class="p">),</span> <span class="mf">2.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="SBprof_to_COG_errorprop"><a class="viewcode-back" href="../../autoprofutils.html#autoprofutils.SharedFunctions.SBprof_to_COG_errorprop">[docs]</a><span class="k">def</span> <span class="nf">SBprof_to_COG_errorprop</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">SB</span><span class="p">,</span> <span class="n">SBE</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">symmetric_error</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a surface brightness profile to a curve of growth by integrating</span>
<span class="sd">    the SB profile in flux units then converting back to mag units. Two methods</span>
<span class="sd">    are implemented, one using the trapezoid method and one assuming constant</span>
<span class="sd">    SB between isophotes. Trapezoid method is in principle more accurate, but</span>
<span class="sd">    may become unstable with erratic data. An uncertainty profile is also</span>
<span class="sd">    computed, from a given SB uncertainty profile and optional axisratio</span>
<span class="sd">    uncertainty profile.</span>
<span class="sd">    </span>
<span class="sd">    R: Radius in arcsec</span>
<span class="sd">    SB: surface brightness in mag arcsec^-2</span>
<span class="sd">    SBE: surface brightness uncertainty relative mag arcsec^-2</span>
<span class="sd">    axisratio: b/a indicating degree of isophote ellipticity</span>
<span class="sd">    axisratioE: uncertainty in b/a</span>
<span class="sd">    N: number of iterations for computing uncertainty</span>
<span class="sd">    method: 0 for trapezoid, 1 for constant</span>
<span class="sd">    </span>
<span class="sd">    returns: magnitude and uncertainty profile in mag</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # If not provided, axis ratio error is assumed to be zero</span>
    <span class="c1"># if axisratioE is None:</span>
    <span class="c1">#     axisratioE = np.zeros(len(R))</span>
        
    <span class="c1"># # Create container for the monte-carlo iterations</span>
    <span class="c1"># COG_results = np.zeros((N, len(R))) + 99.999</span>
    <span class="c1"># SB_CHOOSE = np.logical_and(np.isfinite(SB), SB &lt; 99)</span>
    <span class="c1"># if np.sum(SB_CHOOSE) &lt; 5:</span>
    <span class="c1">#     return (None, None) if symmetric_error else (None, None, None)</span>
    <span class="c1"># COG_results[0][SB_CHOOSE] = SBprof_to_COG(R[SB_CHOOSE], SB[SB_CHOOSE], axisratio[SB_CHOOSE], method = method)</span>
    <span class="c1"># for i in range(1,N):</span>
    <span class="c1">#     # Randomly sampled SB profile</span>
    <span class="c1">#     tempSB = np.random.normal(loc = SB, scale = np.abs(SBE))</span>
    <span class="c1">#     # Randomly sampled axis ratio profile</span>
    <span class="c1">#     tempq = np.random.normal(loc = axisratio, scale = np.abs(axisratioE))</span>
    <span class="c1">#     # Compute COG with sampled data</span>
    <span class="c1">#     COG_results[i][SB_CHOOSE] = SBprof_to_COG(R[SB_CHOOSE], tempSB[SB_CHOOSE], tempq[SB_CHOOSE], method = method)</span>

    <span class="c1"># # Condense monte-carlo evaluations into profile and uncertainty envelope</span>
    <span class="c1"># COG_profile = COG_results[0]</span>
    <span class="c1"># COG_lower = COG_profile - np.quantile(COG_results, 0.317310507863/2, axis = 0)</span>
    <span class="c1"># COG_upper = np.quantile(COG_results, 1. - 0.317310507863/2, axis = 0) - COG_profile</span>

    <span class="c1"># # Return requested uncertainty format</span>
    <span class="c1"># if symmetric_error:</span>
    <span class="c1">#     return COG_profile, np.abs(COG_lower + COG_upper)/2</span>
    <span class="c1"># else:</span>
    <span class="c1">#     return COG_profile, COG_lower, COG_upper</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">Ie</span> <span class="o">=</span> <span class="n">mag_to_flux</span><span class="p">(</span><span class="n">SB</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">SBE</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Fmode_fluxdens_to_fluxsum_errorprop</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Ie</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="n">symmetric_error</span> <span class="o">=</span> <span class="n">symmetric_error</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symmetric_error</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flux_to_mag</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">flux_to_mag</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">flux_to_mag</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lower</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Connor Stone.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>